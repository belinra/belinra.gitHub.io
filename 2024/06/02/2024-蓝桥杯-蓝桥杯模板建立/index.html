
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <title>蓝桥杯模板建立 | 左岚の秘密基地</title>
    <meta name="author" content="左岚" />
    <meta name="description" content="电子信息工程专业的摆子大学生🧐" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>左岚の秘密基地</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;左岚の秘密基地</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>蓝桥杯模板建立</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/6/2
        </span>
        
        <span class="category">
            <a href="/categories/%E8%93%9D%E6%A1%A5%E6%9D%AF/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                蓝桥杯
            </a>
        </span>
        
        
    </div>
    
    <div class="content" v-pre>
        <p>[toc]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="小小的bb几句"><a href="#小小的bb几句" class="headerlink" title="小小的bb几句"></a>小小的bb几句</h3><p>这里我说明一下我个人在学习单片机的时候的一些心得体会，以及大模板的最新建立，会持续更新。</p>
<p>最基础的模版来自于B站Up <a target="_blank" rel="noopener" href="https://space.bilibili.com/1041194501">Alice_西风的个人空间-Alice_西风个人主页-哔哩哔哩视频 (bilibili.com)</a></p>
<p>我的B站为<a target="_blank" rel="noopener" href="https://space.bilibili.com/27619688">左-岚的个人空间-左-岚个人主页-哔哩哔哩视频 (bilibili.com)</a></p>
<p>这篇文章对应着我B站的视频为 <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1F4421Q7Jg/?share_source=copy_web&vd_source=b7273face728021382ab2ce92ffd6efe">【蓝桥杯】【单片机】大模板构建喂饭教程</a></p>
<p>建议搭配着视频使用，不然可能有些地方比较迷糊。</p>
<p>对应的CSDN链接为<a target="_blank" rel="noopener" href="https://blog.csdn.net/zl295871597/article/details/139519652">【喂饭】【速成】蓝桥杯模版手把手建立-CSDN博客</a></p>
<p>对应的知乎链接为<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/702140525">【喂饭】【速成】蓝桥杯模版手把手建立</a></p>
<p>这两个仓库可以删除后面的东西（一直删除到master，可以看到我的全部的东西）</p>
<p>Github的仓库为 <a target="_blank" rel="noopener" href="https://github.com/zuoliangyu/lanqiaobei_study/tree/master/%E6%A8%A1%E6%9D%BF/demo_zuolan">lanqiaobei_study&#x2F;模板&#x2F;demo_zuolan at master · zuoliangyu&#x2F;lanqiaobei_study (github.com)</a><br>Gitee的仓库为 <a target="_blank" rel="noopener" href="https://gitee.com/zuo-lan/blue-bridge-cup-learning/tree/master/%E6%A8%A1%E6%9D%BF/demo_zuolan">模板&#x2F;demo_zuolan · zuoliangyu&#x2F;蓝桥杯学习 - 码云 - 开源中国 (gitee.com)</a></p>
<h3 id="锁存器与三八译码器介绍"><a href="#锁存器与三八译码器介绍" class="headerlink" title="锁存器与三八译码器介绍"></a>锁存器与三八译码器介绍</h3><p>这里我们需要有一个基础知识，就是我们的锁存器和三八译码器介绍，这是一个比较关键的点，我们看到下面这两个图，可以看到我们的锁存器是用P25，P26，P27进行控制，即P2的高三位进行的控制，我们只需要按照如下的命令进行书写即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0</span>x?<span class="number">0</span>;</span><br><span class="line">P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中的P2&amp;&#x3D;0x1f，表示我们将高三位置为0，| 0x?0的操作表明我们对高三位进行书写，比如Y4C，那么就代表我们的高三位要表示为4，即0100，我们将其放在高位，即<strong>100</strong>0_0000，翻译过来就是0x80</p>
<p><img src="https://s2.loli.net/2024/06/07/LcgNid1RyuAqmCO.png" alt="image-20240603102849364"></p>
<p><img src="https://s2.loli.net/2024/06/07/SOLaZjADRBdCKPz.png" alt="image-20240603102505211"></p>
<h3 id="NOP延时函数"><a href="#NOP延时函数" class="headerlink" title="NOP延时函数"></a>NOP延时函数</h3><p>这里要注意一个问题，就是我们延时函数大部分都有NOP，包括Ds1302，IIC都使用了这个，这个函数存在于头文件intrins.h中，需要注意一下引用，一般来说，一个NOP在12MHz的单片机下是1us，其余的自己去换算一下。</p>
<h2 id="LED，蜂鸣器，继电器，MOTOR模版建立"><a href="#LED，蜂鸣器，继电器，MOTOR模版建立" class="headerlink" title="LED，蜂鸣器，继电器，MOTOR模版建立"></a>LED，蜂鸣器，继电器，MOTOR模版建立</h2><h3 id="Led-c"><a href="#Led-c" class="headerlink" title="Led.c"></a>Led.c</h3><blockquote>
<p>这里虽然名称叫做Led.c，但是里面书写LED，蜂鸣器，继电器，MOTOR的代码</p>
</blockquote>
<h4 id="Led底层"><a href="#Led底层" class="headerlink" title="Led底层"></a>Led底层</h4><p>我们可以看到Led的代码，我们可以注意到的是，这个地方使用了static这个关键词，因为我们需要关注内存的使用<del>（这里不得不提C51的垃圾内存容量）</del>，所以我们将其变为函数静态内存，可以有效节省。</p>
<p>传入的参数有两个，一个是addr，代表我们需要控制的Led的地址，（0-7）对应了（L1-L8），另一个是enable，用于控制选中的Led灯的亮灭。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Led_Disp</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> enable)</span></span><br></pre></td></tr></table></figure>

<p>我们定义了两个参数，一个是temp，一个是temp_old，你们可能会好奇，为什么我要在这里用两个变量来进行编写，明明逻辑上只需要用一个变量对P0进行赋值就行了，这里我说明一下，我们一般情况下不会一直操控锁存器，否则有概率影响数码管的显示，当我们状况出现变化（temp!&#x3D;temp_old）的时候，我们才对锁存器P2的高三位进行书写。当我们需要点亮的时候，就让相应的addr变为1；当我们需要熄灭的时候就让相应的addr变为0；</p>
<blockquote>
<p>这里你可能会有疑问，因为我们在原理图上面如果想让Led亮，那么应该给0，这里做一个说明，我们后面会直接取反，这里用1是为了符合我们的直觉<del>（因为正常人就是1亮0灭）</del></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> temp = <span class="number">0x00</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> temp_old = <span class="number">0xff</span>;</span><br><span class="line"><span class="keyword">if</span> (enable)</span><br><span class="line">    temp |= <span class="number">0x01</span> &lt;&lt; addr;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    temp &amp;= ~(<span class="number">0x01</span> &lt;&lt; addr);</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/07/WA8vzFcHU1reiSg.png" alt="image-20240603102116772"></p>
<p>我们通过查看原理图可以看到，用于控制的Load为Y4C，我们通过计算二进制可以发现结果为1000_0000，即0x80，所以我们在这里代码中的P2设置为P2 &#x3D; P2 &amp; 0x1f | 0x80;在运行后别忘记使用P2 &amp;&#x3D; 0x1f来进行高位清零，但是在我们操作P2锁存器之前，我们需要先对P0进行赋值（要记得先取反）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (temp != temp_old) &#123;</span><br><span class="line">    P0 = ~temp;</span><br><span class="line">    P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0x80</span>;</span><br><span class="line">    P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line">    temp_old = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @brief Led扫描</span></span><br><span class="line"><span class="comment">/// @param addr 需要控制的Led的地址（0-7）</span></span><br><span class="line"><span class="comment">/// @param enable 控制该地址的Led是否点亮</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Led_Disp</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> enable)</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> temp = <span class="number">0x00</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> temp_old = <span class="number">0xff</span>;</span><br><span class="line">  <span class="keyword">if</span> (enable)</span><br><span class="line">    temp |= <span class="number">0x01</span> &lt;&lt; addr;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    temp &amp;= ~(<span class="number">0x01</span> &lt;&lt; addr);</span><br><span class="line">  <span class="keyword">if</span> (temp != temp_old) &#123;</span><br><span class="line">    P0 = ~temp;</span><br><span class="line">    P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0x80</span>;</span><br><span class="line">    P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line">    temp_old = temp;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="蜂鸣器，继电器，MOTOR底层"><a href="#蜂鸣器，继电器，MOTOR底层" class="headerlink" title="蜂鸣器，继电器，MOTOR底层"></a>蜂鸣器，继电器，MOTOR底层</h4><p>这里我就一起讲了，因为他们三是一个芯片的不同输出，和上方的Led类似，但是这几个需要一个全局变量（在函数外申明）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> temp_0 = <span class="number">0x00</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> temp_old_0 = <span class="number">0xff</span>;</span><br></pre></td></tr></table></figure>

<p>我们可以看到，BUZZ、MOTOR、RELAY为一个芯片的不同位的输出</p>
<p>RELAY对应I5-&gt;Q4-&gt;D4-&gt;0001_0000-&gt;0x10</p>
<p>MOTOR对应I6-&gt;Q5-&gt;D5-&gt;0010_0000-&gt;0x20</p>
<p>BUZZ对应I7-&gt;Q6-&gt;D6-&gt;0100_0000-&gt;0x80</p>
<p>这里后我们就知道如果我们需要对应的工作，那么就要给P0赋相应的值，并且下方的Y5C也告诉我们，我们需要给锁存器为1010_0000-&gt;0xa0,即P2 &#x3D; P2 &amp; 0x1f | 0xa0;这个之后也别忘了使用P2 &amp;&#x3D; 0x1f来进行高位清零。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (temp_0 != temp_old_0) &#123;</span><br><span class="line">  P0 = temp_0;</span><br><span class="line">  P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xa0</span>;</span><br><span class="line">  P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line">  temp_old_0 = temp_0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/07/jnKlC8sbGtIVH3q.png" alt="image-20240603110637349"></p>
<p>总体代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> temp_0 = <span class="number">0x00</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> temp_old_0 = <span class="number">0xff</span>;</span><br><span class="line"><span class="comment">/// @brief 蜂鸣器控制</span></span><br><span class="line"><span class="comment">/// @param enable</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Beep</span><span class="params">(bit enable)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (enable)</span><br><span class="line">    temp_0 |= <span class="number">0x40</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    temp_0 &amp;= ~(<span class="number">0x40</span>);</span><br><span class="line">  <span class="keyword">if</span> (temp_0 != temp_old_0) &#123;</span><br><span class="line">    P0 = temp_0;</span><br><span class="line">    P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xa0</span>;</span><br><span class="line">    P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line">    temp_old_0 = temp_0;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// @brief 继电器控制</span></span><br><span class="line"><span class="comment">/// @param enable</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Relay</span><span class="params">(bit enable)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (enable)</span><br><span class="line">    temp_0 |= <span class="number">0x10</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    temp_0 &amp;= ~(<span class="number">0x10</span>);</span><br><span class="line">  <span class="keyword">if</span> (temp_0 != temp_old_0) &#123;</span><br><span class="line">    P0 = temp_0;</span><br><span class="line">    P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xa0</span>;</span><br><span class="line">    P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line">    temp_old_0 = temp_0;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// @brief MOTOR控制</span></span><br><span class="line"><span class="comment">/// @param enable</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MOTOR</span><span class="params">(bit enable)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (enable)</span><br><span class="line">    temp_0 |= <span class="number">0x20</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    temp_0 &amp;= ~(<span class="number">0x20</span>);</span><br><span class="line">  <span class="keyword">if</span> (temp_0 != temp_old_0) &#123;</span><br><span class="line">    P0 = temp_0;</span><br><span class="line">    P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xa0</span>;</span><br><span class="line">    P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line">    temp_old_0 = temp_0;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Led-h"><a href="#Led-h" class="headerlink" title="Led.h"></a>Led.h</h3><p>申明代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Led_Disp</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> enable)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Beep</span><span class="params">(bit enable)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Relay</span><span class="params">(bit enable)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">MOTOR</span><span class="params">(bit enable)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Key模版建立"><a href="#Key模版建立" class="headerlink" title="Key模版建立"></a>Key模版建立</h2><h3 id="key-c"><a href="#key-c" class="headerlink" title="key.c"></a>key.c</h3><h4 id="基础代码"><a href="#基础代码" class="headerlink" title="基础代码"></a>基础代码</h4><p>在这里我们可以看到原理图里面的行列显示，最新版的原理图把row和col单独拿出来了，所以可能对应有点麻烦<del>（其实也不麻烦）</del>，如下图所示，我们直接按照一列一列进行扫描，给列低电平后判断指定行是否为低电平，如果指定行为低电平，那么我们就认为这个按键被按下。并且我们在这里不需要实现消抖等操作，我们会在main.c里面实现我们的功能，这里只实现最基础的扫描。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">P44 = <span class="number">0</span>;P42 = <span class="number">1</span>;P35 = <span class="number">1</span>;P34 = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">P44 = <span class="number">1</span>;P42 = <span class="number">0</span>;P35 = <span class="number">1</span>;P34 = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">9</span>;</span><br><span class="line"><span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">P44 = <span class="number">1</span>;P42 = <span class="number">1</span>;P35 = <span class="number">0</span>;P34 = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">14</span>;</span><br><span class="line"><span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">P44 = <span class="number">1</span>;P42 = <span class="number">1</span>;P35 = <span class="number">1</span>;P34 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">17</span>;</span><br><span class="line"><span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">18</span>;</span><br><span class="line"><span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">19</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/07/6sCohX7PLWTDuYQ.png" alt="image-20240603112443055"></p>
<p><img src="https://s2.loli.net/2024/06/07/iKbUM1lzuIsaZYk.png" alt="image-20240603112417611"></p>
<p>在我们把行列扫描写完后就可以完成工作了，但是，我们要注意一个问题，局部变量一定要注意初始化为0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> temp = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>在这里要注意一个问题，我们的串口进行发送的时候会占用P30和P31口，这个是硬件的冲突，所以我们在进入这个扫描函数的时候，需要对其关掉轮询（就是在main函数里面用的什么来进行各个函数定时的定时器，叫做轮询定时器）。这里我用的是定时器1，所以我进入后就要使用ET1&#x3D;0关掉，结束后用P3&#x3D;0xff；ET1&#x3D;1开启。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ET1 = <span class="number">0</span>;</span><br><span class="line">----</span><br><span class="line">P3 = <span class="number">0xff</span>;</span><br><span class="line">ET1 = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>还有一个比较重要的问题，今年（2024）不管是省赛还是国赛都考了ne555的测量，我们ne555的测量要用到P34引脚，也就是我们的按键的最后一列，那么这里就要注意一下，这是一个硬件冲突，且无法解决，所以我们将所有P34删除，就当我们用的按键为4行3列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">P44 = <span class="number">0</span>;P42 = <span class="number">1</span>;P35 = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">P44 = <span class="number">1</span>;P42 = <span class="number">0</span>;P35 = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">9</span>;</span><br><span class="line"><span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">P44 = <span class="number">1</span>;P42 = <span class="number">1</span>;P35 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">14</span>;</span><br><span class="line"><span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">15</span>;</span><br></pre></td></tr></table></figure>

<p>整体代码如下（没有包括ne555，如果有ne555需要把按键扫描换成上面的）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Key_Read</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> temp = <span class="number">0</span>;</span><br><span class="line">  ET1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  P44 = <span class="number">0</span>;P42 = <span class="number">1</span>;P35 = <span class="number">1</span>;P34 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">  P44 = <span class="number">1</span>;P42 = <span class="number">0</span>;P35 = <span class="number">1</span>;P34 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">  P44 = <span class="number">1</span>;P42 = <span class="number">1</span>;P35 = <span class="number">0</span>;P34 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">12</span>;</span><br><span class="line">  <span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">13</span>;</span><br><span class="line">  <span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">14</span>;</span><br><span class="line">  <span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">  P44 = <span class="number">1</span>;P42 = <span class="number">1</span>;P35 = <span class="number">1</span>;P34 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (P33 == <span class="number">0</span>) temp = <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">if</span> (P32 == <span class="number">0</span>) temp = <span class="number">17</span>;</span><br><span class="line">  <span class="keyword">if</span> (P31 == <span class="number">0</span>) temp = <span class="number">18</span>;</span><br><span class="line">  <span class="keyword">if</span> (P30 == <span class="number">0</span>) temp = <span class="number">19</span>;</span><br><span class="line"></span><br><span class="line">  P3 = <span class="number">0xff</span>;</span><br><span class="line">  ET1 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="key-h"><a href="#key-h" class="headerlink" title="key.h"></a>key.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Key_Read</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h2 id="数码管模板建立"><a href="#数码管模板建立" class="headerlink" title="数码管模板建立"></a>数码管模板建立</h2><h3 id="Seg-c"><a href="#Seg-c" class="headerlink" title="Seg.c"></a>Seg.c</h3><h4 id="数码管编码推导"><a href="#数码管编码推导" class="headerlink" title="数码管编码推导"></a>数码管编码推导</h4><p>这里我单独开一个标题来做数码管的编码推导，因为这个很重要，我们看到下方的截图</p>
<p><img src="https://s2.loli.net/2024/06/07/PGxHoOaBwAg187v.png" alt="image-20240603114712357"></p>
<p>可以观察到每一段的数码管都被编号，这里由于我们用的是共阳极数码管，即0亮1灭，下面我给一个🌰来进行说明</p>
<p><img src="https://s2.loli.net/2024/06/07/S2l5KnEXQ8ydmMa.png" alt="image-20240603115210566"></p>
<p>我们标好后按照dp-&gt;g-&gt;…-&gt;a的顺序写出，即1010_0100-&gt;0xa4，这个值在数码管的显示中就代表着“2”</p>
<p>所以我们就可以根据这个规律来编写一个段选表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">code <span class="type">unsigned</span> <span class="type">char</span> seg_dula[] = &#123;<span class="number">0xc0</span>, <span class="number">0xf9</span>, <span class="number">0xa4</span>, <span class="number">0xb0</span>, <span class="number">0x99</span>, <span class="number">0x92</span>,</span><br><span class="line">                                 <span class="number">0x82</span>, <span class="number">0xf8</span>, <span class="number">0x80</span>, <span class="number">0x90</span>, <span class="number">0xff</span>, <span class="number">0x88</span>&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="数码管代码编写"><a href="#数码管代码编写" class="headerlink" title="数码管代码编写"></a>数码管代码编写</h4><p>这是我们最最重要的玩意，因为这个涉及到我们的显示，我们看原理图可以看到，我们需要对数码管进行位选（选择哪一个数码管进行显示），段选（选择数码管显示的数据）。</p>
<p>其中ABCDEFG和DP为我们的段选，COM1-8为我们的位选</p>
<p>我们需要先对P0进行段选显示后，使用P2将锁存器打开（Y7C-&gt;1110_0000-&gt;0xe0）;在对P0进行位选配置后，使用P2将锁存器打开（Y6C-&gt;1100_0000-&gt;0xc0）</p>
<p><img src="https://s2.loli.net/2024/06/07/4RgTfMqvehCXWNi.png" alt="image-20240603113818447"></p>
<p>经过我们的分析后我们就可以知道我们需要传入的数据为wela位选，dula段选，point是否显示小数点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Seg_Disp</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> wela, <span class="type">unsigned</span> <span class="type">char</span> dula, <span class="type">unsigned</span> <span class="type">char</span> point)</span> </span><br></pre></td></tr></table></figure>

<p>我们为了避免闪烁，所以我们需要先对数码管进行消隐，即</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">P0 = <span class="number">0xff</span>;</span><br><span class="line">P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xe0</span>;</span><br><span class="line">P2 &amp;= <span class="number">0x1f</span>;</span><br></pre></td></tr></table></figure>

<p>然后我们对位置进行选择后使用P2打开相应锁存器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">P0 = <span class="number">0x01</span> &lt;&lt; wela;</span><br><span class="line">P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xc0</span>;</span><br><span class="line">P2 &amp;= <span class="number">0x1f</span>;</span><br></pre></td></tr></table></figure>

<p>由于我们可以知道，要显示小数点的话，我们就要让DP为0，其他不变，即&amp;0x7f即可完成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">P0 = seg_dula[dula];</span><br><span class="line"><span class="keyword">if</span> (point) P0 &amp;= <span class="number">0x7f</span>;</span><br><span class="line">P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xe0</span>;</span><br><span class="line">P2 &amp;= <span class="number">0x1f</span>;</span><br></pre></td></tr></table></figure>

<p>总体代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;seg.h&quot;</span></span></span><br><span class="line"><span class="comment">// 0-9 灭</span></span><br><span class="line"><span class="comment">//  A</span></span><br><span class="line">code <span class="type">unsigned</span> <span class="type">char</span> seg_dula[] = &#123;<span class="number">0xc0</span>, <span class="number">0xf9</span>, <span class="number">0xa4</span>, <span class="number">0xb0</span>, <span class="number">0x99</span>, <span class="number">0x92</span>,</span><br><span class="line">                                 <span class="number">0x82</span>, <span class="number">0xf8</span>, <span class="number">0x80</span>, <span class="number">0x90</span>, <span class="number">0xff</span>, <span class="number">0x88</span>&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Seg_Disp</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> wela, <span class="type">unsigned</span> <span class="type">char</span> dula, <span class="type">unsigned</span> <span class="type">char</span> point)</span> &#123;</span><br><span class="line">  <span class="comment">// 消隐</span></span><br><span class="line">  P0 = <span class="number">0xff</span>;</span><br><span class="line">  P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xe0</span>;</span><br><span class="line">  P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位选</span></span><br><span class="line">  P0 = <span class="number">0x01</span> &lt;&lt; wela;</span><br><span class="line">  P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xc0</span>;</span><br><span class="line">  P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 段选</span></span><br><span class="line">  P0 = seg_dula[dula];</span><br><span class="line">  <span class="keyword">if</span> (point) P0 &amp;= <span class="number">0x7f</span>;</span><br><span class="line">  P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xe0</span>;</span><br><span class="line">  P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Seg-h"><a href="#Seg-h" class="headerlink" title="Seg.h"></a>Seg.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Seg_Disp</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> wela, <span class="type">unsigned</span> <span class="type">char</span> dula, <span class="type">unsigned</span> <span class="type">char</span> point)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Ds1302时钟模版建立"><a href="#Ds1302时钟模版建立" class="headerlink" title="Ds1302时钟模版建立"></a>Ds1302时钟模版建立</h2><h3 id="Ds1302-c"><a href="#Ds1302-c" class="headerlink" title="Ds1302.c"></a>Ds1302.c</h3><p>这里有官方提供的参考代码，所以我们上面的时序可以不用书写，我们直接对下方的时间读取&#x2F;写入进行操作</p>
<h4 id="官方的参考代码"><a href="#官方的参考代码" class="headerlink" title="官方的参考代码"></a>官方的参考代码</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*	# 	DS1302代码片段说明</span></span><br><span class="line"><span class="comment">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。</span></span><br><span class="line"><span class="comment">        2.</span></span><br><span class="line"><span class="comment">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题</span></span><br><span class="line"><span class="comment">                中对单片机时钟频率的要求，进行代码调试和修改。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Write_Ds1302</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> temp)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    SCK = <span class="number">0</span>;</span><br><span class="line">    SDA = temp &amp; <span class="number">0x01</span>;</span><br><span class="line">    temp &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    SCK = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Write_Ds1302_Byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> address, <span class="type">unsigned</span> <span class="type">char</span> dat)</span> &#123;</span><br><span class="line">  RST = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SCK = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  RST = <span class="number">1</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  Write_Ds1302(address);</span><br><span class="line">  Write_Ds1302(dat);</span><br><span class="line">  RST = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Read_Ds1302_Byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> address)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i, temp = <span class="number">0x00</span>;</span><br><span class="line">  RST = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SCK = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  RST = <span class="number">1</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  Write_Ds1302(address);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    SCK = <span class="number">0</span>;</span><br><span class="line">    temp &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (SDA) temp |= <span class="number">0x80</span>;</span><br><span class="line">    SCK = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  RST = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SCK = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SCK = <span class="number">1</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SDA = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SDA = <span class="number">1</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  <span class="keyword">return</span> (temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="我们需要补充的代码"><a href="#我们需要补充的代码" class="headerlink" title="我们需要补充的代码"></a>我们需要补充的代码</h4><p>首先是我们需要绑定SDA，RST，SCK的引脚，在原理图中可以看到，并且要注意一个问题，我们用到了NOP函数，所以需要引入头文件intrins.h</p>
<p><img src="https://s2.loli.net/2024/06/07/ZViOBuWyY8oSKMD.png" alt="image-20240603120352094"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span></span></span><br><span class="line">sbit SDA = P2 ^ <span class="number">3</span>;</span><br><span class="line">sbit RST = P1 ^ <span class="number">3</span>;</span><br><span class="line">sbit SCK = P1 ^ <span class="number">7</span>;</span><br></pre></td></tr></table></figure>

<p>然后就是我们的读写时钟，观察芯片手册可以看到</p>
<p><img src="https://s2.loli.net/2024/06/07/uy8o21I73fOEvXg.png" alt="image-20240603120847616"></p>
<p>我们如果需要读取时钟的话，只需要读取地址0x85-&gt;小时 0x83-&gt;分钟 0x81-&gt;秒钟</p>
<p>我们如果需要写入时钟的话，需要先将0x8E位置的最高位WP置0，解除写保护后才能进行写入，写入的地址为0x84-&gt;小时 0x82-&gt;分钟 0x80-&gt;秒钟</p>
<p>所以我们的代码编写就很简单了,我们传入数据为数组的指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Set_Rtc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *ucRtc)</span> </span><br><span class="line"><span class="type">void</span> <span class="title function_">Read_Rtc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *ucRtc)</span> </span><br></pre></td></tr></table></figure>

<p>这里给一个调用的示例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> time[<span class="number">3</span>] = &#123;<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>&#125;;<span class="comment">//11:12:13</span></span><br><span class="line">Set_Rtc(time);</span><br><span class="line">Read_Rtc(time);</span><br></pre></td></tr></table></figure>

<p>我们在写入之前需要进行解锁写保护，写完后就进行写保护</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Write_Ds1302_Byte(<span class="number">0x8e</span>, <span class="number">0x00</span>);</span><br><span class="line">-----</span><br><span class="line">Write_Ds1302_Byte(<span class="number">0x8e</span>, <span class="number">0x80</span>);</span><br></pre></td></tr></table></figure>

<p>我们在使用的过程中可以直接使用for循环进行读取&#x2F;写入，由于我们为了方便，所以我们在这里使用十进制进行存储和读取（本质上存储和读取的都是二进制BCD码，比如0x11我们读取为11，写入为11，在里面内部使用变量进行转换）</p>
<p>举个🌰，我们假设要写入的时间为23:59:58，那么我们实际上要写入芯片的数据为0x23 0x59 0x58</p>
<p>但是我们为了方便（因为有时候需要我们是设置时钟，加减的那种，直接使用bcd码不方便，需要我们判断是否达到0xa0然后进行转换），这里我们可以在里面写一个十进制转为十进制bcd码的公式就行，以写入0x23为例，我们输入给我们Set_Rtc函数的数据为23，我们要先将其转换为0x23才能进行写入，那么我们可以观察一下，本质上就是把十位和个位分开，然后再存入即可，我们分开很简单，直接&#x2F;10和%10就可以取出十位和个位，然后再使用&lt;&lt;4来进行高位移位，将我们的十位移动到高四位去，然后|上我们的个位（低四位）就可以将其拼接完成。</p>
<p>23-&gt;2,3-&gt;0010,0011-&gt;0100_0011</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp = ucRtc[i] / <span class="number">10</span> &lt;&lt; <span class="number">4</span> | ucRtc[i] % <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>同理，我们读取的时候读取到的都是十进制的bcd码，那么我们将其转换后再读出</p>
<p>0x23-&gt;0x2,0x3-&gt;2*10+3-&gt;23</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ucRtc[i] = temp &gt;&gt; <span class="number">4</span> * <span class="number">10</span> + temp &amp; <span class="number">0x0f</span>;</span><br></pre></td></tr></table></figure>

<p>读取和写入的代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//写入 </span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    temp = ucRtc[i] / <span class="number">10</span> &lt;&lt; <span class="number">4</span> | ucRtc[i] % <span class="number">10</span>;</span><br><span class="line">    Write_Ds1302_Byte(<span class="number">0x84</span> - <span class="number">2</span> * i, temp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//读取</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    temp = Read_Ds1302_Byte(<span class="number">0x85</span> - <span class="number">2</span> * i);</span><br><span class="line">    ucRtc[i] = temp &gt;&gt; <span class="number">4</span> * <span class="number">10</span> + temp &amp; <span class="number">0x0f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要补充的完整代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 十进制 11 -&gt; 0x11</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Set_Rtc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *ucRtc)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> temp;</span><br><span class="line">  Write_Ds1302_Byte(<span class="number">0x8e</span>, <span class="number">0x00</span>);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    temp = ucRtc[i] / <span class="number">10</span> &lt;&lt; <span class="number">4</span> | ucRtc[i] % <span class="number">10</span>;</span><br><span class="line">    Write_Ds1302_Byte(<span class="number">0x84</span> - <span class="number">2</span> * i, temp);</span><br><span class="line">  &#125;</span><br><span class="line">  Write_Ds1302_Byte(<span class="number">0x8e</span>, <span class="number">0x80</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 十进制 0x11 -&gt; 11</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Read_Rtc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *ucRtc)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> temp;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    temp = Read_Ds1302_Byte(<span class="number">0x85</span> - <span class="number">2</span> * i);</span><br><span class="line">    ucRtc[i] = temp &gt;&gt; <span class="number">4</span> * <span class="number">10</span> + temp &amp; <span class="number">0x0f</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*	# 	DS1302代码片段说明</span></span><br><span class="line"><span class="comment">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。</span></span><br><span class="line"><span class="comment">        2.</span></span><br><span class="line"><span class="comment">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题</span></span><br><span class="line"><span class="comment">                中对单片机时钟频率的要求，进行代码调试和修改。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds1302.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span></span></span><br><span class="line">sbit SDA = P2 ^ <span class="number">3</span>;</span><br><span class="line">sbit RST = P1 ^ <span class="number">3</span>;</span><br><span class="line">sbit SCK = P1 ^ <span class="number">7</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Write_Ds1302</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> temp)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    SCK = <span class="number">0</span>;</span><br><span class="line">    SDA = temp &amp; <span class="number">0x01</span>;</span><br><span class="line">    temp &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    SCK = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Write_Ds1302_Byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> address, <span class="type">unsigned</span> <span class="type">char</span> dat)</span> &#123;</span><br><span class="line">  RST = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SCK = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  RST = <span class="number">1</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  Write_Ds1302(address);</span><br><span class="line">  Write_Ds1302(dat);</span><br><span class="line">  RST = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Read_Ds1302_Byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> address)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i, temp = <span class="number">0x00</span>;</span><br><span class="line">  RST = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SCK = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  RST = <span class="number">1</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  Write_Ds1302(address);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    SCK = <span class="number">0</span>;</span><br><span class="line">    temp &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (SDA) temp |= <span class="number">0x80</span>;</span><br><span class="line">    SCK = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  RST = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SCK = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SCK = <span class="number">1</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SDA = <span class="number">0</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  SDA = <span class="number">1</span>;</span><br><span class="line">  _nop_();</span><br><span class="line">  <span class="keyword">return</span> (temp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 十进制 11 -&gt; 0x11</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Set_Rtc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *ucRtc)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> temp;</span><br><span class="line">  Write_Ds1302_Byte(<span class="number">0x8e</span>, <span class="number">0x00</span>);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    temp = ucRtc[i] / <span class="number">10</span> &lt;&lt; <span class="number">4</span> | ucRtc[i] % <span class="number">10</span>;</span><br><span class="line">    Write_Ds1302_Byte(<span class="number">0x84</span> - <span class="number">2</span> * i, temp);</span><br><span class="line">  &#125;</span><br><span class="line">  Write_Ds1302_Byte(<span class="number">0x8e</span>, <span class="number">0x80</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 十进制 0x11 -&gt; 11</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Read_Rtc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *ucRtc)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> temp;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    temp = Read_Ds1302_Byte(<span class="number">0x85</span> - <span class="number">2</span> * i);</span><br><span class="line">    ucRtc[i] = temp &gt;&gt; <span class="number">4</span> * <span class="number">10</span> + temp &amp; <span class="number">0x0f</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ds1302-h"><a href="#Ds1302-h" class="headerlink" title="Ds1302.h"></a>Ds1302.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Set_Rtc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *ucRtc)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Read_Rtc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *ucRtc)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Onewire温度模版建立"><a href="#Onewire温度模版建立" class="headerlink" title="Onewire温度模版建立"></a>Onewire温度模版建立</h2><h3 id="Onewire-c"><a href="#Onewire-c" class="headerlink" title="Onewire.c"></a>Onewire.c</h3><h4 id="官方的参考代码-1"><a href="#官方的参考代码-1" class="headerlink" title="官方的参考代码"></a>官方的参考代码</h4><p>这里有官方提供的参考代码，所以我们上面的时序可以不用书写，我们直接对下方的进行温度读取操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*	# 	单总线代码片段说明</span></span><br><span class="line"><span class="comment">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。</span></span><br><span class="line"><span class="comment">        2.</span></span><br><span class="line"><span class="comment">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题</span></span><br><span class="line"><span class="comment">                中对单片机时钟频率的要求，进行代码调试和修改。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_OneWire</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> t)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">while</span> (t--) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Write_DS18B20</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> dat)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    DQ = <span class="number">0</span>;</span><br><span class="line">    DQ = dat &amp; <span class="number">0x01</span>;</span><br><span class="line">    Delay_OneWire(<span class="number">5</span>);</span><br><span class="line">    DQ = <span class="number">1</span>;</span><br><span class="line">    dat &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Delay_OneWire(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Read_DS18B20</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> dat;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    DQ = <span class="number">0</span>;</span><br><span class="line">    dat &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    DQ = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (DQ) &#123;</span><br><span class="line">      dat |= <span class="number">0x80</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Delay_OneWire(<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> dat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">bit <span class="title function_">init_ds18b20</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  bit initflag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  DQ = <span class="number">1</span>;</span><br><span class="line">  Delay_OneWire(<span class="number">12</span>);</span><br><span class="line">  DQ = <span class="number">0</span>;</span><br><span class="line">  Delay_OneWire(<span class="number">80</span>);</span><br><span class="line">  DQ = <span class="number">1</span>;</span><br><span class="line">  Delay_OneWire(<span class="number">10</span>);</span><br><span class="line">  initflag = DQ;</span><br><span class="line">  Delay_OneWire(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> initflag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="我们需要补充的代码-1"><a href="#我们需要补充的代码-1" class="headerlink" title="我们需要补充的代码"></a>我们需要补充的代码</h4><p>首先是我们需要绑定DQ的引脚，在原理图中可以看到</p>
<p><img src="https://s2.loli.net/2024/06/07/ZRTvchqmNoHJkyz.png" alt="image-20240603151248313"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbit DQ = P1 ^ <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<p>我们不需要管上方的时序的书写，只需要进行温度读取的代码书写就行，</p>
<p>下方是温度芯片的使用顺序（官方手册），首先我们需要运行init，然后再检查rom（可跳过），最后执行我们的功能函数，注意，一次只能使用一个功能。</p>
<p><img src="https://s2.loli.net/2024/06/07/2jNgpahnkTGfmRv.png" alt="image-20240603151648898"></p>
<p>我们可以在官方手册上找到需要运行的指令</p>
<p><img src="https://s2.loli.net/2024/06/07/SCYHXMG5cKOn2oq.png" alt="image-20240603151943165"></p>
<p>当我们发送0xcc的时候，就会跳过ROM检查，并且这里也说明了，我们发送0x44就可以开启温度转换，发送0xbe就可以开始读取温度，但是要注意一个事情，我们同样可以在我们的官方的手册上面找到一段读取的语句，这里表明我们先读取低位，再读取高位，最后将其拼接后再*精度就是我们的数据了</p>
<p><img src="https://s2.loli.net/2024/06/07/pWyValBnu7i3vjR.png" alt="image-20240603152342393"></p>
<p>温度的精度在文档中对应如下</p>
<p><img src="https://s2.loli.net/2024/06/07/IeSagVktWAXzcy5.png" alt="image-20240603152557565"></p>
<p>精度为9-&gt;0.5;10-&gt;0.25;11-&gt;0.125;12（默认）-&gt;0.0625</p>
<p>我们就可以根据上面的描述来进行代码书写</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">rd_temperature</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> low, high;</span><br><span class="line">    <span class="comment">//开启温度转换</span></span><br><span class="line">    init_ds18b20();</span><br><span class="line">    Write_DS18B20(<span class="number">0xcc</span>);</span><br><span class="line">    Write_DS18B20(<span class="number">0x44</span>);</span><br><span class="line">    Delay_OneWire(<span class="number">200</span>);</span><br><span class="line">    <span class="comment">//开启温度读取</span></span><br><span class="line">    init_ds18b20();</span><br><span class="line">    Write_DS18B20(<span class="number">0xcc</span>);</span><br><span class="line">    Write_DS18B20(<span class="number">0xbe</span>);</span><br><span class="line">    low = Read_DS18B20();</span><br><span class="line">    high = Read_DS18B20();</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">float</span>)(high &lt;&lt; <span class="number">8</span> | low) * <span class="number">0.0625</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里给一个调用示例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> temp = rd_temperature();</span><br></pre></td></tr></table></figure>

<p>完整代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*	# 	单总线代码片段说明</span></span><br><span class="line"><span class="comment">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。</span></span><br><span class="line"><span class="comment">        2.</span></span><br><span class="line"><span class="comment">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题</span></span><br><span class="line"><span class="comment">                中对单片机时钟频率的要求，进行代码调试和修改。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;onewire.h&quot;</span></span></span><br><span class="line">sbit DQ = P1 ^ <span class="number">4</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_OneWire</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> t)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">while</span> (t--) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Write_DS18B20</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> dat)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    DQ = <span class="number">0</span>;</span><br><span class="line">    DQ = dat &amp; <span class="number">0x01</span>;</span><br><span class="line">    Delay_OneWire(<span class="number">5</span>);</span><br><span class="line">    DQ = <span class="number">1</span>;</span><br><span class="line">    dat &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Delay_OneWire(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Read_DS18B20</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> dat;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    DQ = <span class="number">0</span>;</span><br><span class="line">    dat &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    DQ = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (DQ) &#123;</span><br><span class="line">      dat |= <span class="number">0x80</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Delay_OneWire(<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> dat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">bit <span class="title function_">init_ds18b20</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  bit initflag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  DQ = <span class="number">1</span>;</span><br><span class="line">  Delay_OneWire(<span class="number">12</span>);</span><br><span class="line">  DQ = <span class="number">0</span>;</span><br><span class="line">  Delay_OneWire(<span class="number">80</span>);</span><br><span class="line">  DQ = <span class="number">1</span>;</span><br><span class="line">  Delay_OneWire(<span class="number">10</span>);</span><br><span class="line">  initflag = DQ;</span><br><span class="line">  Delay_OneWire(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> initflag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">rd_temperature</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> low, high;</span><br><span class="line">  init_ds18b20();</span><br><span class="line">  Write_DS18B20(<span class="number">0xcc</span>);</span><br><span class="line">  Write_DS18B20(<span class="number">0x44</span>);</span><br><span class="line">  Delay_OneWire(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">  init_ds18b20();</span><br><span class="line">  Write_DS18B20(<span class="number">0xcc</span>);</span><br><span class="line">  Write_DS18B20(<span class="number">0xbe</span>);</span><br><span class="line">  low = Read_DS18B20();</span><br><span class="line">  high = Read_DS18B20();</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">float</span>)(high &lt;&lt; <span class="number">8</span> | low) * <span class="number">0.0625</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Onewire-h"><a href="#Onewire-h" class="headerlink" title="Onewire.h"></a>Onewire.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"><span class="type">float</span> <span class="title function_">rd_temperature</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h2 id="IIC（PCF8591-AD-DA-与AT24C02-EEPROM-）模版建立"><a href="#IIC（PCF8591-AD-DA-与AT24C02-EEPROM-）模版建立" class="headerlink" title="IIC（PCF8591(AD&#x2F;DA)与AT24C02(EEPROM)）模版建立"></a>IIC（PCF8591(AD&#x2F;DA)与AT24C02(EEPROM)）模版建立</h2><h3 id="iic-c"><a href="#iic-c" class="headerlink" title="iic.c"></a>iic.c</h3><h4 id="官方的参考代码-2"><a href="#官方的参考代码-2" class="headerlink" title="官方的参考代码"></a>官方的参考代码</h4><p>这里有官方提供的参考代码，所以我们上面的时序可以不用书写，我们直接进行AD读取与DA输出还有AT24C02的存储操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*	#   I2C代码片段说明</span></span><br><span class="line"><span class="comment">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。</span></span><br><span class="line"><span class="comment">        2.</span></span><br><span class="line"><span class="comment">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题</span></span><br><span class="line"><span class="comment">                中对单片机时钟频率的要求，进行代码调试和修改。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELAY_TIME 10</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">I2C_Delay</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> n)</span> &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">  &#125; <span class="keyword">while</span> (n--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CStart</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  sda = <span class="number">0</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CStop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  sda = <span class="number">0</span>;</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CSendByte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> byt)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    scl = <span class="number">0</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    <span class="keyword">if</span> (byt &amp; <span class="number">0x80</span>) &#123;</span><br><span class="line">      sda = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      sda = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    scl = <span class="number">1</span>;</span><br><span class="line">    byt &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">I2CReceiveByte</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> da;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    scl = <span class="number">1</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    da &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (sda) da |= <span class="number">0x01</span>;</span><br><span class="line">    scl = <span class="number">0</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> da;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">I2CWaitAck</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> ackbit;</span><br><span class="line"></span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  ackbit = sda;</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ackbit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CSendAck</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> ackbit)</span> &#123;</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">  sda = ackbit;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="我们需要补充的代码-2"><a href="#我们需要补充的代码-2" class="headerlink" title="我们需要补充的代码"></a>我们需要补充的代码</h4><p>首先是我们需要绑定sda和scl的引脚，在原理图中可以看到，并且要注意一个问题，我们用到了NOP函数，所以需要引入头文件intrins.h</p>
<p><img src="https://s2.loli.net/2024/06/07/LHlKeUbFZJ6hWXs.png" alt="image-20240603153405955"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span></span></span><br><span class="line">sbit scl = P2 ^ <span class="number">0</span>;</span><br><span class="line">sbit sda = P2 ^ <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>我在这里需要说明一下IIC通信的方式，他是一个一个八位的数据，其中第一位是我们的发送地址，永远都是1，然后后面挂载了不同的外设，我们的蓝桥杯的板子挂了两个外设，一个是PCF8591，对应着AD&#x2F;DA的功能；另一个是AT24C02，对应着EEPROM的存储功能。在我们板子上就长我们下面这个样子<del>（我画的有点抽象）</del>，所以我们就可以知道，如果我们要对AT24C02芯片写入数据的话，我们就需要使用地址为（1010_0000-&gt;0xa0），要读取数据的化，我们就要使用地址为（1010_0001-&gt;0xa1）;要写入DA输出的数据的话，我们就需要使用地址为（1001_0000-&gt;0x90），要读取AD采样的数据的话，我们就需要使用地址为（1001_0001-&gt;0x91）</p>
<p><img src="https://s2.loli.net/2024/06/07/ToIADWrKHpauZCS.png" alt="image-20240603154239060"></p>
<p>在我们使用IIC进行通信的时候，我们要遵循下面的运行逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I2CStart();</span><br><span class="line">I2CSendByte(地址);</span><br><span class="line">I2CWaitAck();</span><br><span class="line">I2CSendByte(功能);</span><br><span class="line">I2CWaitAck();</span><br></pre></td></tr></table></figure>

<h5 id="AD与DA"><a href="#AD与DA" class="headerlink" title="AD与DA"></a>AD与DA</h5><p>从上面说明的内容的我们可以知道，如果我们要对PCF8591进行操作，那么就需要对地址0x90和0x91进行操作</p>
<p>我们现在先说一下AD的代码，通过观察原理图我们可以发现，AD有4个通道可以进行读取</p>
<p><img src="https://s2.loli.net/2024/06/07/hswAvxcGJIzaTCr.png" alt="image-20240604090624435"></p>
<p>其中AIN0通道是我们的外部测量通道（由于蓝桥杯现在还没有涉及到信号发生器，所以我们可以先暂时不用管这个通道）</p>
<p><img src="https://s2.loli.net/2024/06/07/MaXAhJ7doT1RjN3.png" alt="image-20240604091125348"></p>
<p>AIN1通道很明显就是光明电阻的分压读取（光照越强，分压越高，采集到的结果越大），</p>
<p>AIN2通道为差分输入（我们也是不常用到的输入，因为没有信号发生器）</p>
<p>AIN3通道为滑动变阻器输入（我们测量滑动变阻器的分压，这个你左右旋钮看一下就知道哪边变大了）</p>
<p><img src="https://s2.loli.net/2024/06/07/O9723EqKubWDUzl.png" alt="image-20240604091205128"></p>
<p>我们查看一下PCF8591的手册可以看到，我们读取的地址的书写方式，这里我统一给一个说明</p>
<table>
<thead>
<tr>
<th align="center">位次</th>
<th align="center">情况说明</th>
<th align="center">情况</th>
</tr>
</thead>
<tbody><tr>
<td align="center">第一位</td>
<td align="center">固定位</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">第二位</td>
<td align="center">是否需要开启DA输出</td>
<td align="center">开启DA输出（1）<br />不开启DA输出（0）</td>
</tr>
<tr>
<td align="center">第三四位</td>
<td align="center">选择输入通道的模式<br />差分输入具体要看下面的图</td>
<td align="center">通道与编号对应输入（常用）（00）<br />通道差分输入（01,10,11）</td>
</tr>
<tr>
<td align="center">第五位</td>
<td align="center">固定位</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">第六位</td>
<td align="center">自动递增标志<br />（用于一个一个读取AD输入口）</td>
<td align="center">自我递增（没考过，因为我们一般都是单一读取）（1）<br />不自我递增（0）</td>
</tr>
<tr>
<td align="center">第七八位</td>
<td align="center">用于指定我们读取的通道</td>
<td align="center">通道0（00），在我们正常的对应输入下为外部信号输入<br />通道1（01），在我们正常的对应输入下为光明电阻分压输入<br />通道2（10），在我们正常的对应输入下为差分信号输入<br />通道3，在我们正常的对应输入下为滑动变阻器分压输入（11）</td>
</tr>
</tbody></table>
<p><img src="https://s2.loli.net/2024/06/07/Z3nqoYTKGVXPwAj.png" alt="image-20240604092329778"></p>
<p>我们那么这个时候常考的就是下面的形式，注意一下题目中是否需求DA输出，如果需要DA输出的话，这里使用地址的时候必须使用允许DA输出，</p>
<table>
<thead>
<tr>
<th align="center">需要的数据</th>
<th align="center">输入的地址</th>
</tr>
</thead>
<tbody><tr>
<td align="center">外部电压输入（开启DA）</td>
<td align="center">0100_0000-&gt;0x40</td>
</tr>
<tr>
<td align="center">外部电压输入（不开启DA）</td>
<td align="center">0000_0000-&gt;0x00</td>
</tr>
<tr>
<td align="center">光敏电阻分压输入（开启DA）</td>
<td align="center">0100_0001-&gt;0x41</td>
</tr>
<tr>
<td align="center">光敏电阻分压输入（不开启DA）</td>
<td align="center">0000_0001-&gt;0x01</td>
</tr>
<tr>
<td align="center">差分信号输入（开启DA）</td>
<td align="center">0100_0010-&gt;0x42</td>
</tr>
<tr>
<td align="center">差分信号输入（不开启DA）</td>
<td align="center">0000_0010-&gt;0x02</td>
</tr>
<tr>
<td align="center">滑动变阻器分压输入（开启DA）</td>
<td align="center">0100_0011-&gt;0x43</td>
</tr>
<tr>
<td align="center">滑动变阻器分压输入（不开启DA）</td>
<td align="center">0000_0011-&gt;0x03</td>
</tr>
</tbody></table>
<p>有了这样一个基础，我们就可以开始着手编写我们的AD代码了</p>
<p>我们只需要指定一下我们需要读取的通道的地址就行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Ad_Read</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr)</span> </span><br></pre></td></tr></table></figure>

<p>这里给一个调用示例，这里需要注意的是，如果你同时读取光敏电阻和滑动变阻器的值，他们会地址交换，你们可以自己去试试。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> temp = Ad_Read(<span class="number">0x01</span>);<span class="comment">//读取光敏电阻结果 </span></span><br></pre></td></tr></table></figure>

<p>首先我们需要选中我们的PCF芯片并且写入我们需要读取的地址,这里需要注意的就只有每次发送Byte后我们需要Wait一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择芯片为PCF</span></span><br><span class="line">I2CStart();</span><br><span class="line">I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">I2CWaitAck();</span><br><span class="line">I2CSendByte(addr);</span><br><span class="line">I2CWaitAck();</span><br></pre></td></tr></table></figure>

<p>然后重新开启一下通话（因为我们上面是进行写操作，现在要进行读操作），读取后我们需要发送一个Ack为1，表明我们这边接收数据完成，后续不用接受了，结束后就可以关闭对话Stop了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">I2CStart();</span><br><span class="line">I2CSendByte(<span class="number">0x91</span>);</span><br><span class="line">I2CWaitAck();</span><br><span class="line">temp = I2CReceiveByte();</span><br><span class="line">I2CSendAck(<span class="number">1</span>);</span><br><span class="line">I2CStop();</span><br></pre></td></tr></table></figure>

<p>AD完整代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Ad_Read</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> temp;</span><br><span class="line">  <span class="comment">// 选择芯片为PCF</span></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(addr);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line"></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0x91</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  temp = I2CReceiveByte();</span><br><span class="line">  I2CSendAck(<span class="number">1</span>);</span><br><span class="line">  I2CStop();</span><br><span class="line">  <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说完AD我们就要说到DA了</p>
<p>和AD一样，我们只需要传入我们需要写入的数据就行，但是要注意一下我们的数据为数字电压，即0-255，我们输出后的电压是模拟电压，即0-5V，所以我们是一一映射过去的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Da_Write</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> dat)</span> </span><br></pre></td></tr></table></figure>

<p>举个🌰，我们如果想要输出电压为2V,那么我们就应该</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Da_Write(<span class="number">2</span>*<span class="number">51</span>); </span><br></pre></td></tr></table></figure>

<p>如果想要输出的电压为2.5V，那么我们就应该，这里不用关心他会出现不匹配的情况，C语言底层会自动转换为unsigned char类型的,这类有啊注意</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Da_Write(<span class="number">2.5</span>*<span class="number">51</span>); </span><br></pre></td></tr></table></figure>

<p>首先我们需要选中我们的PCF芯片并且给他我们的地址信息（前面提到过如果要开启DA输出，那么我们应该写入的地址）,这里需要注意的就只有每次发送Byte后我们需要Wait一下，这里的0x41可以更换为0x40-0x43的任何一个，但是最好和题目中要求AD需要读取的通道一致（这里也要注意在你读取AD的时候加上0x4）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Da_Write</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> dat)</span> &#123;</span><br><span class="line">  <span class="comment">// 选择芯片为PCF</span></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(<span class="number">0x41</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(dat);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AD与</p>
<h5 id="EEPROM"><a href="#EEPROM" class="headerlink" title="EEPROM"></a>EEPROM</h5><p>从上面说明的内容的我们可以知道，如果我们要对AT24C02进行操作，那么就需要对地址0xa0和0xa1进行操作</p>
<p>本质上我们的EEPROM写入与读取和AD&#x2F;DA是一致的，但是我们需要注意一个点，因为我们通常写入&#x2F;读取的不止一个数据，我们一般是一个数组写进去和读取，所以我们就需要注意这个点，我们的操作如下，传递的数据都是数组的首地址（如果存单个数据只需要使用&amp;name就行），传入参数为需要写入&#x2F;读取数组首地址名称））str，需要写入&#x2F;读取的数组地址addr，数组的大小num</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_Write</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str, <span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> num)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_Read</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str, <span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> num)</span> </span><br></pre></td></tr></table></figure>

<p>这里给一个调用的示例，需要注意一下如果写入为unsigned int，可以不用分为高低位存储，但是需要分为高低位读取</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> arr_input[<span class="number">5</span>]=&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> arr_output[<span class="number">5</span>];</span><br><span class="line">EEPROM_Write(arr_input,<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line">EEPROM_Read(arr_output,<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> input = <span class="number">5</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> output;</span><br><span class="line">EEPROM_Write(&amp;input,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">EEPROM_Read(&amp;output,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> input = <span class="number">5</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> output;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> high,low;</span><br><span class="line">EEPROM_Write(&amp;input,<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">EEPROM_Read(&amp;high,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">EEPROM_Read(&amp;low,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">output = high&lt;&lt;<span class="number">4</span> | low;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在我来说一下实现细节</p>
<p>先说明一下EEPROM_Read函数，和上文的AD读取一样，我们需要先选中AT24C02，并且功能为写，然后进行位置的传输，确认我们需要读取的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I2CStart();</span><br><span class="line">I2CSendByte(<span class="number">0xa0</span>);</span><br><span class="line">I2CWaitAck();</span><br><span class="line">I2CSendByte(addr);</span><br><span class="line">I2CWaitAck();</span><br></pre></td></tr></table></figure>

<p>在我们读取的时候，和上文AD一样，我们需要重新开启一个对话进行读取</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">I2CStart();</span><br><span class="line">I2CSendByte(<span class="number">0xa1</span>);</span><br><span class="line">I2CWaitAck();</span><br></pre></td></tr></table></figure>

<p>但是在我们读取的时候需要注意一个点，我们使用的数组进行的数据读取，并且在我们读取的时候对指针进行++操作，当我们还没有读完数据的时候，我们发送Ack为0，代表我们需要继续读取，当我们读取数据结束后，我们发送Ack为1，表示读取结束，最后也别忘记需要进行Stop停止交流。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">I2CStart();</span><br><span class="line">I2CSendByte(<span class="number">0xa1</span>);</span><br><span class="line">I2CWaitAck();</span><br><span class="line"><span class="keyword">while</span> (num--) &#123;</span><br><span class="line">    *str++ = I2CReceiveByte();</span><br><span class="line">    <span class="keyword">if</span> (num)</span><br><span class="line">        I2CSendAck(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        I2CSendAck(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">I2CStop();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在这里说明一下*str++代表的含义，这是c的一个写法，等价于下面的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> arr[<span class="number">5</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> num = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span>(num--)</span><br><span class="line">&#123;</span><br><span class="line">	arr[i] = I2CReceiveByte();</span><br><span class="line">i++;</span><br><span class="line">-----</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>完整的代码EEPROM_READ如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_Read</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str, <span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> num)</span> &#123;</span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xa0</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(addr);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line"></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xa1</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  <span class="keyword">while</span> (num--) &#123;</span><br><span class="line">    *str++ = I2CReceiveByte();</span><br><span class="line">    <span class="keyword">if</span> (num)</span><br><span class="line">      I2CSendAck(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      I2CSendAck(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  I2CStop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以从上面看到，AD和EEPROM_READ可以进行类比；同理，我们的DA和EEPROM_Write也可以进行类比，但是EEPROM_Write有一个需要注意的点，我会在下面进行说明</p>
<p>我们第一步还是选择我们的芯片，选择我们需要写入的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I2CStart();</span><br><span class="line">I2CSendByte(<span class="number">0xa0</span>);</span><br><span class="line">I2CWaitAck();</span><br><span class="line">I2CSendByte(addr);</span><br><span class="line">I2CWaitAck();</span><br></pre></td></tr></table></figure>

<p>第二步就是使用一个循环进行写入，这里需要注意一个问题，就是我们每写入一个数据，都需要I2C_Delay一下，注意不是Delay，而是I2C_Delay，经过我们测试，当这个值为200 的时候效果是可以的，并且这里有个最最重要的点，在我们Stop结束后，我们需要进行4个255时间的I2C_Delay<del>（其实我在群里面说过，但你们一直觉得我在讲乐子）</del></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (num--) &#123;</span><br><span class="line">    I2CSendByte(*str++);</span><br><span class="line">    I2CWaitAck();</span><br><span class="line">    I2C_Delay(<span class="number">200</span>);</span><br><span class="line">&#125;</span><br><span class="line">I2CStop();</span><br><span class="line">I2C_Delay(<span class="number">255</span>);</span><br><span class="line">I2C_Delay(<span class="number">255</span>);</span><br><span class="line">I2C_Delay(<span class="number">255</span>);</span><br><span class="line">I2C_Delay(<span class="number">255</span>);</span><br></pre></td></tr></table></figure>

<p>完整的代码EEPROM_Write如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_Write</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str, <span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> num)</span> &#123;</span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xa0</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(addr);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (num--) &#123;</span><br><span class="line">    I2CSendByte(*str++);</span><br><span class="line">    I2CWaitAck();</span><br><span class="line">    I2C_Delay(<span class="number">200</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  I2CStop();</span><br><span class="line">  I2C_Delay(<span class="number">255</span>);</span><br><span class="line">  I2C_Delay(<span class="number">255</span>);</span><br><span class="line">  I2C_Delay(<span class="number">255</span>);</span><br><span class="line">  I2C_Delay(<span class="number">255</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*	#   I2C代码片段说明</span></span><br><span class="line"><span class="comment">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。</span></span><br><span class="line"><span class="comment">        2.</span></span><br><span class="line"><span class="comment">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题</span></span><br><span class="line"><span class="comment">                中对单片机时钟频率的要求，进行代码调试和修改。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELAY_TIME 5</span></span><br><span class="line">sbit scl = P2 ^ <span class="number">0</span>;</span><br><span class="line">sbit sda = P2 ^ <span class="number">1</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">I2C_Delay</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> n)</span> &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">  &#125; <span class="keyword">while</span> (n--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CStart</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  sda = <span class="number">0</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CStop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  sda = <span class="number">0</span>;</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CSendByte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> byt)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    scl = <span class="number">0</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    <span class="keyword">if</span> (byt &amp; <span class="number">0x80</span>) &#123;</span><br><span class="line">      sda = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      sda = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    scl = <span class="number">1</span>;</span><br><span class="line">    byt &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">I2CReceiveByte</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> da;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    scl = <span class="number">1</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    da &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (sda) da |= <span class="number">0x01</span>;</span><br><span class="line">    scl = <span class="number">0</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> da;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">I2CWaitAck</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> ackbit;</span><br><span class="line"></span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  ackbit = sda;</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ackbit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CSendAck</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> ackbit)</span> &#123;</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">  sda = ackbit;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Ad_Read</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> temp;</span><br><span class="line">  <span class="comment">// 选择芯片为PCF</span></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(addr);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line"></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0x91</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  temp = I2CReceiveByte();</span><br><span class="line">  I2CSendAck(<span class="number">1</span>);</span><br><span class="line">  I2CStop();</span><br><span class="line">  <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 数字电压255-&gt;5V</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Da_Write</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> dat)</span> &#123;</span><br><span class="line">  <span class="comment">// 选择芯片为PCF</span></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(<span class="number">0x41</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(dat);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_Write</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str, <span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> num)</span> &#123;</span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xa0</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(addr);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (num--) &#123;</span><br><span class="line">    I2CSendByte(*str++);</span><br><span class="line">    I2CWaitAck();</span><br><span class="line">    I2C_Delay(<span class="number">200</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  I2CStop();</span><br><span class="line">  I2C_Delay(<span class="number">255</span>);</span><br><span class="line">  I2C_Delay(<span class="number">255</span>);</span><br><span class="line">  I2C_Delay(<span class="number">255</span>);</span><br><span class="line">  I2C_Delay(<span class="number">255</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_Read</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str, <span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> num)</span> &#123;</span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xa0</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(addr);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line"></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xa1</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  <span class="keyword">while</span> (num--) &#123;</span><br><span class="line">    *str++ = I2CReceiveByte();</span><br><span class="line">    <span class="keyword">if</span> (num)</span><br><span class="line">      I2CSendAck(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      I2CSendAck(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  I2CStop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="iic-h"><a href="#iic-h" class="headerlink" title="iic.h"></a>iic.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Ad_Read</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Da_Write</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> dat)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_Write</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str, <span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> num)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_Read</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str, <span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> num)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Uart串口模版建立"><a href="#Uart串口模版建立" class="headerlink" title="Uart串口模版建立"></a>Uart串口模版建立</h2><h3 id="uart-c"><a href="#uart-c" class="headerlink" title="uart.c"></a>uart.c</h3><p>在这里我们需要注意，串口官方是没有给底层的，我们需要自己手搓，在这里我给的代码为重定向代码。</p>
<p>首先是使用isp生成一个用定时器2计时的串口1的代码，波特率为9600（比赛的时候可能不是9600，要根据题目来看），定时器时钟选用12T，数据位为8位</p>
<p><img src="https://s2.loli.net/2024/06/07/oWcze7YF6ASNX1G.png" alt="image-20240604144711333"></p>
<p>我们直接把他复制到我们代码里面就行，最后别忘记加一个EA&#x3D;1来开启总中断，还有些isp版本可能比较老，没有使能中断的选项，所以需要自己加上ES&#x3D;1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Uart1_Init</span><span class="params">(<span class="type">void</span>)</span>  <span class="comment">// 9600bps@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  SCON = <span class="number">0x50</span>;   <span class="comment">// 8位数据,可变波特率</span></span><br><span class="line">  AUXR |= <span class="number">0x01</span>;  <span class="comment">// 串口1选择定时器2为波特率发生器</span></span><br><span class="line">  AUXR |= <span class="number">0x04</span>;  <span class="comment">// 定时器时钟1T模式</span></span><br><span class="line">  T2L = <span class="number">0xC7</span>;    <span class="comment">// 设置定时初始值</span></span><br><span class="line">  T2H = <span class="number">0xFE</span>;    <span class="comment">// 设置定时初始值</span></span><br><span class="line">  AUXR |= <span class="number">0x10</span>;  <span class="comment">// 定时器2开始计时</span></span><br><span class="line">  ES = <span class="number">1</span>;        <span class="comment">// 使能串口1中断</span></span><br><span class="line">  EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们这里不需要实现复杂的函数，只需要实现一个重定向就行，使用printf直接将数据发送到串口就行，我现在说一下步骤</p>
<p>我们通过查看c51里面（注意是c51，不是标准的c语言函数库，直接在keil里面右键打开），我们可以看到下方有一个putchar的一个extern的函数定义，这就是我们需要重载的函数，因为我们printf本质上就是调用putchar的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">STDIO.H</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Prototypes for standard I/O functions.</span></span><br><span class="line"><span class="comment">Copyright (c) 1988-2002 Keil Elektronik GmbH and Keil Software, Inc.</span></span><br><span class="line"><span class="comment">All rights reserved.</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __STDIO_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __STDIO_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> EOF</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> EOF -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NULL</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> NULL ((void *) 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SIZE_T</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> _SIZE_T</span></span><br><span class="line"> <span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="type">size_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> SAVE</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> REGPARMS</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> _getkey (<span class="type">void</span>);</span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> <span class="title function_">getchar</span> <span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> <span class="title function_">ungetchar</span> <span class="params">(<span class="type">char</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> <span class="title function_">putchar</span> <span class="params">(<span class="type">char</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">printf</span>   <span class="params">(<span class="type">const</span> <span class="type">char</span> *, ...)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">sprintf</span>  <span class="params">(<span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, ...)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">vprintf</span>  <span class="params">(<span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">vsprintf</span> <span class="params">(<span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> *<span class="title function_">gets</span> <span class="params">(<span class="type">char</span> *, <span class="type">int</span> n)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">scanf</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *, ...)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">sscanf</span> <span class="params">(<span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, ...)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">puts</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> RESTORE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以知道，串口在发送的时候，会将数据放进缓冲区SBUF（如果你用串口2那就是S2BUF，但是这里没涉及到，就不用管了），当我们正在发送的时候TI标志位为0，当我们发送完成后，他就会被置为0，然后我们需要将ch返回（这个是函数本身就需要返回的char）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">char</span> <span class="title function_">putchar</span><span class="params">(<span class="type">char</span> ch)</span> &#123;</span><br><span class="line">  SBUF = ch;</span><br><span class="line">  <span class="keyword">while</span> (TI == <span class="number">0</span>);</span><br><span class="line">  TI = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="uart-h"><a href="#uart-h" class="headerlink" title="uart.h"></a>uart.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Uart1_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Ul超声波模版建立"><a href="#Ul超声波模版建立" class="headerlink" title="Ul超声波模版建立"></a>Ul超声波模版建立</h2><h3 id="ul-c"><a href="#ul-c" class="headerlink" title="ul.c"></a>ul.c</h3><p>在这里我们需要注意，串口官方是没有给底层的，我们需要自己手搓。我们通过查询原理图可以看到，超声波的T为P10，R为P11，所以我们需要定义一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sbit Tx = P1 ^ <span class="number">0</span>;</span><br><span class="line">sbit Rx = P1 ^ <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/07/5sNVCegmFoRDHpx.png" alt="image-20240604151041554"></p>
<p>现在我们来进行逻辑的书写，我们首先要知道超声波测距的原理，我发送数据后，等待接收数据，那么我通过计算发送和接收中的间隔时间，就可以得到我们的距离，这里用数学公式可以进行计算，一般来说声速都是340m&#x2F;s（也不排除题目里面和你说要对其进行变换啥的【比如第十四届国赛】，这里就按照声速为340m&#x2F;s来进行说明）</p>
<p>$$<br>d &#x3D; \frac{vt}{2} &#x3D; \frac{340 \text{ m&#x2F;s} \times t}{2} &#x3D; 170 \text{ m&#x2F;s} \times t &#x3D; 1.7 \times 10^4 \text{ cm&#x2F;s} \times t<br>$$</p>
<p>我们这里有一个单位换算需要进行注意，t的单位为us，也就是</p>
<p>$$<br>{10^{ - 6}}s<br>$$</p>
<p>我们进行完整的单位换算就可以知道d的距离了（单位为cm）</p>
<p>$$<br>d &#x3D; 1.7*{10^4}*{10^{ - 6}}t &#x3D; 0.017t<br>$$</p>
<p>图来自微信群友chmod-wrx绘制（我绘图太🌶︎🐔了）</p>
<p><img src="https://s2.loli.net/2024/06/07/dSbl3gPewWzUcrj.png" alt="image-20240604153314869"></p>
<p>根据我们上方的分析，我们可以知道我们首先需要进行发送，我们在这里发送8个40kHz的方波进行测量，那么周期就是</p>
<p>$$<br>{1 \over {40k}} &#x3D; 25 \cdot {10^{ - 6}}s &#x3D; 25us<br>$$</p>
<p>也就是我们需要<br>$<br>12us<br>$<br>将发送的电平进行反转</p>
<p>代码如下，我们首先使用isp生成一个12us的延时函数,这里需要注意的是要正确使用系统频率为12MHz；如果这里测量结果有问题，可以尝试将33修改为38或者其他的数据，因为软件延时不准。</p>
<p><img src="https://s2.loli.net/2024/06/07/ZhKAk2iCFxE3TQs.png" alt="image-20240604153718702"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Delay12us</span><span class="params">(<span class="type">void</span>)</span>	<span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> data i;</span><br><span class="line"></span><br><span class="line">	_nop_();</span><br><span class="line">	_nop_();</span><br><span class="line">	i = <span class="number">33</span>;<span class="comment">//可以修改为其他数据，比如38</span></span><br><span class="line">	<span class="keyword">while</span> (--i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就是我们的超声波发送函数，发送8个4kHz的方波</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Ut_Wave_Init</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    Tx = <span class="number">1</span>;</span><br><span class="line">    Delay12us();</span><br><span class="line">    Tx = <span class="number">0</span>;</span><br><span class="line">    Delay12us();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后是我们最重要的数据接收与转换函数的书写，在这里我们使用的pca定时器，可以节省定时器来进行其他的操作（因为ne555强制占用定时器0，串口考到就会占用一个定时器，还有一个定时器需要用来进行函数轮询，所以我们就必须用其他的定时器进行超声波的操作）,其实PCA本质上还是一个定时器，所以他也存在一些定时器的参数，比如TLx-&gt;CL;THx-&gt;CH;TMOD-&gt;CMOD;TRx-&gt;CR;TFx-&gt;CF</p>
<p>我们首先需要对定时器的CH和CL清零，为了我们计数做准备；然后将CMOD配置为0x00，十六位不重载定时器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CH = CL = <span class="number">0</span>;</span><br><span class="line">CMOD = <span class="number">0x00</span>;</span><br></pre></td></tr></table></figure>

<p>在我们发送超声波的时候，我们需要将总中断关闭，在我们发送完毕后就关掉，在我们发送完成后，就打开CR开始计时，等待我们收到回应（收到回应后Rx为0）或者计数溢出（溢出后CF为1），我们就关闭CR开始读取数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EA = <span class="number">0</span>;</span><br><span class="line">Ut_Wave_Init();</span><br><span class="line">EA = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">CR = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (Rx &amp;&amp; !CF);</span><br><span class="line">CR = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>如果我们是因为收到回应而结束（那么就代表我们测量到了数据），那么我们就进行时间读取，如下所示，你们可能会好奇为什么+3，这是因为我们实际测量发现，+3后在远程数据（测量结果&gt;10的时候）误差会比较小，而近程数据（测量数据&lt;10）满足误差范围，我们也不可能测量得到0这个数据（题目中一般都不会测到0）（所以我们才把他视为测量错误的返回结果）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">time = CH &lt;&lt; <span class="number">8</span> | CL;  </span><br><span class="line"><span class="keyword">return</span> (<span class="number">0.017</span> * time + <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>如果我们是因为计数溢出（没有收到返回的信号，代表测量错误），我们就直接返回为0，表示错误结果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>转换的完整代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Ut_Wave_Data</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> time;</span><br><span class="line">  CH = CL = <span class="number">0</span>;</span><br><span class="line">  CMOD = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">  EA = <span class="number">0</span>;</span><br><span class="line">  Ut_Wave_Init();</span><br><span class="line">  EA = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  CR = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (Rx &amp;&amp; !CF);</span><br><span class="line">  CR = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (!CF) &#123;  <span class="comment">// us -&gt; s 10^(-6)</span></span><br><span class="line">    <span class="comment">// m -&gt; cm 10^2</span></span><br><span class="line">    <span class="comment">//  10^(-4)</span></span><br><span class="line">    <span class="comment">// L = V*T/2=340*time/2=170*10^(-4)*time=0.017*time</span></span><br><span class="line">    time = CH &lt;&lt; <span class="number">8</span> | CL;  </span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0.017</span> * time + <span class="number">3</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    CF = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ul.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span></span></span><br><span class="line">sbit Tx = P1 ^ <span class="number">0</span>;</span><br><span class="line">sbit Rx = P1 ^ <span class="number">1</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay12us</span><span class="params">(<span class="type">void</span>)</span>  <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> data i;</span><br><span class="line"></span><br><span class="line">  _nop_();</span><br><span class="line">  _nop_();</span><br><span class="line">  i = <span class="number">33</span>;  <span class="comment">// 38</span></span><br><span class="line">  <span class="keyword">while</span> (--i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Ut_Wave_Init</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    Tx = <span class="number">1</span>;</span><br><span class="line">    Delay12us();</span><br><span class="line">    Tx = <span class="number">0</span>;</span><br><span class="line">    Delay12us();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Ut_Wave_Data</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> time;</span><br><span class="line">  CH = CL = <span class="number">0</span>;</span><br><span class="line">  CMOD = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">  EA = <span class="number">0</span>;</span><br><span class="line">  Ut_Wave_Init();</span><br><span class="line">  EA = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  CR = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (Rx &amp;&amp; !CF);</span><br><span class="line">  CR = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (!CF) &#123;  <span class="comment">// us -&gt; s 10^(-6)</span></span><br><span class="line">    <span class="comment">// m -&gt; cm 10^2</span></span><br><span class="line">    <span class="comment">//  10^(-4)</span></span><br><span class="line">    <span class="comment">// L = V*T/2=340*time/2=170*10^(-4)*time=0.017*time</span></span><br><span class="line">    time = CH &lt;&lt; <span class="number">8</span> | CL;  </span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0.017</span> * time + <span class="number">3</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    CF = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ul-h"><a href="#ul-h" class="headerlink" title="ul.h"></a>ul.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Ut_Wave_Data</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h2 id="init初始化模版建立"><a href="#init初始化模版建立" class="headerlink" title="init初始化模版建立"></a>init初始化模版建立</h2><h3 id="init-c"><a href="#init-c" class="headerlink" title="init.c"></a>init.c</h3><p>我们在启动开发板的时候最好对其进行初始化，关闭蜂鸣器和继电器，MOTOR和全部LED灯，避免上电情况有误</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;init.h&quot;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">System_Init</span><span class="params">()</span> &#123;</span><br><span class="line">  P0 = <span class="number">0xff</span>;</span><br><span class="line">  P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0x80</span>;</span><br><span class="line">  P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line"></span><br><span class="line">  P0 = <span class="number">0x00</span>;</span><br><span class="line">  P2 = P2 &amp; <span class="number">0x1f</span> | <span class="number">0xa0</span>;</span><br><span class="line">  P2 &amp;= <span class="number">0x1f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="init-h"><a href="#init-h" class="headerlink" title="init.h"></a>init.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">System_Init</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h2 id="main主函数书写"><a href="#main主函数书写" class="headerlink" title="main主函数书写"></a>main主函数书写</h2><h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><p>现在我们来进行主函数的编写，我也拆分为模块，但是最后还是会给一个整体的代码</p>
<h4 id="全部变量的归纳"><a href="#全部变量的归纳" class="headerlink" title="全部变量的归纳"></a>全部变量的归纳</h4><p>这里我把全部的全局变量放上来</p>
<blockquote>
<ul>
<li>定义了Led的变量数组，用于控制8个灯的亮灭情况</li>
<li>定义了Seg_Pos的变量，用于控制数码管位选情况</li>
<li>定义了Seg_Buf的变量数组，用于控制每个数码管显示第数据</li>
<li>定义了Seg_Point的变量数组，用于控制某一位数码管是否显示小数点</li>
<li>定义了Uart_Buf的变量数组，用于获取串口接收的数据</li>
<li>定义了Uart_Rx_Index的变量，用于对串口接收后的数组进行索引</li>
<li>定义了Uart_flag的变量，用于判断当前是否正处于串口接收状态</li>
<li>定义了Sys_Tick的变量，用于嘀嗒计时，判断串口是否接收状态超过了10ms</li>
<li>定义了ucRtc的变量数组，用于存放时钟数据，时分秒</li>
<li>定义了int型的计时变量time_all_1s，用于全局定时</li>
<li>定义了int型的频率变量Freq，用于测频结果的存放</li>
</ul>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* LED与数码管 */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> ucLed[<span class="number">8</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Seg_Pos;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Seg_Buf[<span class="number">8</span>] = &#123;<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Seg_Point[<span class="number">8</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 串口数据*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Uart_Buf[<span class="number">10</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Uart_Rx_Index;</span><br><span class="line">bit Uart_flag;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Sys_Tick;</span><br><span class="line"><span class="comment">/* 时间*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> ucRtc[<span class="number">3</span>] = &#123;<span class="number">11</span>, <span class="number">11</span>, <span class="number">11</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> time_all_1s;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 数据 */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> Freq;<span class="comment">//ne555测频</span></span><br></pre></td></tr></table></figure>

<h4 id="数据读取模块"><a href="#数据读取模块" class="headerlink" title="数据读取模块"></a>数据读取模块</h4><p>我们单独写一个模块对数据进行读取，方便我们进行不同数据的操作，这里使用%的操作来进行时间的定时，比如我们的时间读取，就每隔50ms（因为我定时器是1ms）进行一次；AD读取每隔100ms一次；温度读取每隔500ms一次（这里仅作参考，后续还是要自己搓一下试试）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Data_Proc</span><span class="params">()</span> </span><br><span class="line">  <span class="title function_">if</span> <span class="params">(time_all_1s % <span class="number">50</span> == <span class="number">0</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 时间读取</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// AD读取</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">500</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 温度读取</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Key键盘模块"><a href="#Key键盘模块" class="headerlink" title="Key键盘模块"></a>Key键盘模块</h4><p>这个模块是重中之重，因为用到了一个很精妙的三行代码消抖方法，这个在我以前的视频<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Cx421y7qn/">蓝桥杯单片机按键考点</a>里面提到过，点击这行字体就可以跳转过去，我这里简单说明一下，我们的逻辑如下，Key_Val,Key_Old,Key_Down,Key_Up,这几个变量都是下面的逻辑，我们这里对其的原理进行解析</p>
<blockquote>
<p>瞬时值获取-&gt; 获取按下的值，获取抬起的值-&gt;更新⼀下值</p>
<p>Down和Up都是瞬时值，Old比Val延后10ms，基于这个特性我们可以进行书写代码</p>
</blockquote>
<p><img src="https://s2.loli.net/2024/06/07/asTIfD8JhKuctzl.png" alt="image-20240604200625869"></p>
<p>对应的代码如下，我们将这四个变量设置为静态局部变量，可以有效节省内存空间，使用if语句那一段表明我们选择10ms跑一次代码（因为我们定时是1ms的）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Key_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> Key_Val, Key_Down, Key_Up, Key_Old;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">10</span>) <span class="keyword">return</span>;</span><br><span class="line">  Key_Val = Key_Read();</span><br><span class="line">  Key_Down = Key_Val &amp; (Key_Old ^ Key_Val);</span><br><span class="line">  Key_Up = ~Key_Val &amp; (Key_Old ^ Key_Val);</span><br><span class="line">  Key_Old = Key_Val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果理解不了上面的图和代码，我就拿一个🌰来进行验证，比如我们按下&#x2F;抬起S4来做一下验证</p>
<table>
<thead>
<tr>
<th align="center">键盘状态</th>
<th align="center">Key_Old</th>
<th align="center">Key_Val</th>
<th align="center">Key_Old^Key_Val</th>
<th align="center">Key_Down</th>
<th align="center">Key_Up</th>
</tr>
</thead>
<tbody><tr>
<td align="center">未按下</td>
<td align="center">0000</td>
<td align="center">0000</td>
<td align="center">0000^0000&#x3D;0000</td>
<td align="center">0000</td>
<td align="center">0000</td>
</tr>
<tr>
<td align="center">按下过程中（10ms）</td>
<td align="center">0000</td>
<td align="center">0100</td>
<td align="center">0000^0100&#x3D;0100</td>
<td align="center">0100&amp;0100&#x3D;0100</td>
<td align="center">1011&amp;0100&#x3D;0000</td>
</tr>
<tr>
<td align="center">按下稳定（10ms后）</td>
<td align="center">0100</td>
<td align="center">0100</td>
<td align="center">0100^0100&#x3D;0000</td>
<td align="center">0100&amp;0000&#x3D;0000</td>
<td align="center">1011&amp;0000&#x3D;0000</td>
</tr>
<tr>
<td align="center">抬起过程（10ms）</td>
<td align="center">0100</td>
<td align="center">0000</td>
<td align="center">0100^0000&#x3D;0100</td>
<td align="center">0000&amp;0100&#x3D;0000</td>
<td align="center">1111&amp;0100&#x3D;0100</td>
</tr>
</tbody></table>
<p>我们可以从这里看出，当我们按下的时候，那一瞬间Down会是4（注意是一瞬间），其余时候都是0；同理Up也是一样，当我们抬起的瞬间Up会是4（注意是一瞬间），其余时候是0</p>
<p>那么我们如何在这个代码里面进行书写呢，其实很简单，我们一般判断按键都是判断的按键按下，即Down的数据，那么我们按照下面这样写就行，下面就是按下S4的一个示例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Key_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> Key_Val, Key_Down, Key_Up, Key_Old;</span><br><span class="line">    <span class="keyword">if</span> (time_all_1s % <span class="number">10</span>) <span class="keyword">return</span>;</span><br><span class="line">    Key_Val = Key_Read();</span><br><span class="line">    Key_Down = Key_Val &amp; (Key_Old ^ Key_Val);</span><br><span class="line">    Key_Up = ~Key_Val &amp; (Key_Old ^ Key_Val);</span><br><span class="line">    Key_Old = Key_Val;</span><br><span class="line">    <span class="keyword">if</span>(Key_Down == <span class="number">4</span>)</span><br><span class="line">        <span class="comment">//执行按下S4的函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Seg数码管模块"><a href="#Seg数码管模块" class="headerlink" title="Seg数码管模块"></a>Seg数码管模块</h4><p>这个和V2模版不一样，他将数据读取放出去了，所以我们的数码管里面不过多涉及到数据读取，这里选择的是20ms进行一次数码管状态更新</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Seg_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">20</span>) <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何使用呢，其实也非常简单，我们只需要按照下方的写法即可（因为一般来说我们都有多个界面进行切换，我们定义一个变量Seg_Show_Mode来进行书写，如果有子界面的话，拿我们就再定义一个mode就行）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Seg_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (time_all_1s % <span class="number">20</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">switch</span>(Seg_Show_Mode)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="comment">//xx界面</span></span><br><span class="line">            Seg_Buf[<span class="number">0</span>] = xx;</span><br><span class="line">            Seg_Buf[<span class="number">1</span>] = xx;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="comment">//xx界面</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Led灯模块"><a href="#Led灯模块" class="headerlink" title="Led灯模块"></a>Led灯模块</h4><p>这里面我的话经常放的是Led，蜂鸣器，继电器，MOTOR口的相关逻辑，这里不需要设置定时进入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Led_Proc</span><span class="params">()</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用示例如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Led_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">    ucLed[<span class="number">0</span>] = <span class="number">1</span>;<span class="comment">//L1点亮</span></span><br><span class="line">    ucLed[<span class="number">1</span>] = <span class="number">0</span>;<span class="comment">//L2熄灭</span></span><br><span class="line">    Relay(<span class="number">1</span>);<span class="comment">//打开继电器（L10亮）</span></span><br><span class="line">    Beep(<span class="number">1</span>);<span class="comment">//蜂鸣器开启</span></span><br><span class="line">    MOTOR(<span class="number">1</span>);<span class="comment">//MOTOR输出高电平</span></span><br><span class="line">    Relay(<span class="number">0</span>);<span class="comment">//关闭继电器（L10灭）</span></span><br><span class="line">    Beep(<span class="number">0</span>);<span class="comment">//蜂鸣器关闭</span></span><br><span class="line">    MOTOR(<span class="number">0</span>);<span class="comment">//MOTOR输出低电平</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Uart串口模块"><a href="#Uart串口模块" class="headerlink" title="Uart串口模块"></a>Uart串口模块</h4><p>我们在这里使用了串口超时解析，即10ms内没有收集到串口的信息的时候我们才进入并进行解析（后续在定时器里面会提到这个Sys_Tick），在我们解析结束后使用memset函数将接收的数组置为0（为了防止后续解析被干扰），并将索引置为0，为下一次接收解析进行准备</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Uart_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (Uart_Rx_Index == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (Sys_Tick &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">    Sys_Tick = Uart_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(Uart_Buf, <span class="number">0</span>, Uart_Rx_Index);</span><br><span class="line">    Uart_Rx_Index = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用示例，这里发送小写的ok返回hello，注意一下，判断的时候用的是单引号而不是双引号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Uart_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (Uart_Rx_Index == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (Sys_Tick &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">    Sys_Tick = Uart_flag = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(Uart_Buf[<span class="number">0</span>]==<span class="string">&#x27;o&#x27;</span>&amp;&amp;Uart_Buf[<span class="number">1</span>]==<span class="string">&#x27;k&#x27;</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(Uart_Buf, <span class="number">0</span>, Uart_Rx_Index);</span><br><span class="line">    Uart_Rx_Index = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="定时器0初始化（NE555模块）"><a href="#定时器0初始化（NE555模块）" class="headerlink" title="定时器0初始化（NE555模块）"></a>定时器0初始化（NE555模块）</h4><p>这个模块是最有意思的，首先我们需要注意一下，P34和singal的跳线帽要插在一起，并且按键方面需要删除P34，然后才能开始测，这里依然用isp生成一下初始化的定时器0，但是这里要注意，新版的不能生成0ms，我们就随便生成个时间，然后按照我这样勾选后复制粘贴就行</p>
<p><img src="https://s2.loli.net/2024/06/07/HlZIGUcQTDK2OBo.png" alt="image-20240604202942361"></p>
<p>我们需要将TL0和TH0的值改为0，并且在TMOD &amp;&#x3D; 0xF0;下面对其进行配置  TMOD |&#x3D; 0x05;将其变为十六位不自动重载（这里具体可以参考手册里面对于定时器的配置，我之前的视频有提到<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Fk4y1f7LS/">蓝桥杯单片机ne555模块</a>，点击即可观看），这里别忘了EA开启总中断（这是我的习惯），频率的读取放在定时器1那里讲</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Timer0_Init</span><span class="params">(<span class="type">void</span>)</span>  <span class="comment">// 1毫秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  AUXR &amp;= <span class="number">0x7F</span>;  <span class="comment">// 定时器时钟12T模式</span></span><br><span class="line">  TMOD &amp;= <span class="number">0xF0</span>;  <span class="comment">// 设置定时器模式</span></span><br><span class="line">  TMOD |= <span class="number">0x05</span>;</span><br><span class="line">  TL0 = <span class="number">0</span>;  <span class="comment">// 设置定时初始值</span></span><br><span class="line">  TH0 = <span class="number">0</span>;  <span class="comment">// 设置定时初始值</span></span><br><span class="line">  TF0 = <span class="number">0</span>;  <span class="comment">// 清除TF0标志</span></span><br><span class="line">  TR0 = <span class="number">1</span>;  <span class="comment">// 定时器0开始计时</span></span><br><span class="line">  EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="定时器1初始化"><a href="#定时器1初始化" class="headerlink" title="定时器1初始化"></a>定时器1初始化</h4><p>这是我们轮询的定时器的初始化代码，我们使用isp生成1ms定时器1的代码（记得勾选上使能），老版本没有使能，所以记得加上ET1 &#x3D; 1开启</p>
<p><img src="https://s2.loli.net/2024/06/07/BaihIcRuyDYwAXr.png" alt="image-20240604203409782"></p>
<p>当然，不要忘记EA &#x3D; 1，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Timer1_Init</span><span class="params">(<span class="type">void</span>)</span>  <span class="comment">// 1毫秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  AUXR &amp;= <span class="number">0xBF</span>;  <span class="comment">// 定时器时钟12T模式</span></span><br><span class="line">  TMOD &amp;= <span class="number">0x0F</span>;  <span class="comment">// 设置定时器模式</span></span><br><span class="line">  TL1 = <span class="number">0x18</span>;    <span class="comment">// 设置定时初始值</span></span><br><span class="line">  TH1 = <span class="number">0xFC</span>;    <span class="comment">// 设置定时初始值</span></span><br><span class="line">  TF1 = <span class="number">0</span>;       <span class="comment">// 清除TF1标志</span></span><br><span class="line">  TR1 = <span class="number">1</span>;       <span class="comment">// 定时器1开始计时</span></span><br><span class="line">  ET1 = <span class="number">1</span>;       <span class="comment">// 使能定时器1中断</span></span><br><span class="line">  EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="定时器1中断（重点）"><a href="#定时器1中断（重点）" class="headerlink" title="定时器1中断（重点）"></a>定时器1中断（重点）</h4><p>我们在这里放了一堆东西，这里我做一下说明，我们每个中断都有对应的中断号（可以在官方的手册查到），这里定时器1的中断号是3</p>
<p>然后是我们的一个全局定时器（1s，注意time_all_1s的类型要是unsigned int，不然会溢出），在这个定时器里面我们对频率进行了读取，将TH0 &lt;&lt; 8 | TL0的结果给了Freq（注意一下Freq的类型要是unsigned int，不然会溢出），在我们读取完数据后，将TH0和TL0进行了置0手动重载，方便下一次进行测量</p>
<p>接着就是一个和Sys_Tick相关的代码，当我们接收到数据的时候Uart_flag会置为1，然后将Sys_Tick置为0，也就是说我们一段时间不接受数据的话，那么Sys_Tick的值会一直累加，直到达到10ms（我们上面在Uart串口模块里面的设定），Uart_flag置为0，Sys_Tick的值置为0，为下一轮串口解析做准备</p>
<p>然后就是我们的一个位选的代码，因为我们数码管本质上是一位一位显示，所以我们需要写一个位选的变量来进行位选，这里使用的Seg_Pos &#x3D; (++Seg_Pos) % 8将Seg_Pos这个变量在0~7中间进行循环</p>
<p>接着就是我们的数码管显示函数，这里不需要多说了，保持他不变就行，传入为位选、位选对应的段选显示、位选对应的小数点显示</p>
<p>最后就是我们的Led显示函数，这里我并没有选择和数码管同步，而是选择在中断里面写了个for循环来进行显示，因为它不涉及到扫描等操作，本质上就是可以直接一起显示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Timer1_Isr</span><span class="params">(<span class="type">void</span>)</span> interrupt 3 &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">if</span> (++time_all_1s == <span class="number">1000</span>) &#123;</span><br><span class="line">    time_all_1s = <span class="number">0</span>;</span><br><span class="line">    Freq = TH0 &lt;&lt; <span class="number">8</span> | TL0;</span><br><span class="line">    TH0 = TL0 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Uart_flag) Sys_Tick++;</span><br><span class="line">  Seg_Pos = (++Seg_Pos) % <span class="number">8</span>;</span><br><span class="line">  Seg_Disp(Seg_Pos, Seg_Buf[Seg_Pos], Seg_Point[Seg_Pos]);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) Led_Disp(i, ucLed[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="串口中断（这里代码写死）"><a href="#串口中断（这里代码写死）" class="headerlink" title="串口中断（这里代码写死）"></a>串口中断（这里代码写死）</h4><p>我们串口有一个接收中断，串口1的中断号查询后发现为4</p>
<p>我们第一行就是判断是否RI为1，因为RI为1则代表有信息过来了，当我们收集到信息时，我们将Uart_flag置为1，Sys_Tick置为0，开始嘀嗒计时，当我们10ms没有接收到新的数据的时候，我们就认为数据接收完成，可以开始进行串口处理，后面的接收就不需要多讲了，我们是一位一位进行接收的，而读写都是用的SBUF这个缓冲区（串口1，如果是串口2则是S2BUF，但是串口2不会考，所以这里不用管），我们接收完成后，将RI置为0，为下一次接收做准备，最后一行的&gt;10清零，则是为了避免出现传入数据溢出，导致程序异常，这里的10取决于你的字符串数组的位数，我在最上面定的是10位，所以这里写的10</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Uart1_Isr</span><span class="params">(<span class="type">void</span>)</span> interrupt 4 &#123;</span><br><span class="line">  <span class="keyword">if</span> (RI) &#123;</span><br><span class="line">    Uart_flag = <span class="number">1</span>;</span><br><span class="line">    Sys_Tick = <span class="number">0</span>;</span><br><span class="line">    Uart_Buf[Uart_Rx_Index] = SBUF;</span><br><span class="line">    Uart_Rx_Index++;</span><br><span class="line">    RI = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Uart_Rx_Index &gt; <span class="number">10</span>) Uart_Rx_Index = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="main主函数书写-1"><a href="#main主函数书写-1" class="headerlink" title="main主函数书写"></a>main主函数书写</h4><p>这是我们的一个最初的函数，没什么好说明的，就是需要进行一些初始化而已，但是顺序不要写错了，首先是系统初始化，然后是定时器0（ne555），最后是定时器1（轮询）的初始化。</p>
<p>你可以发现，我在这里进行了一次温度的空读取，因为温度上电后会显示85（温度转换的时间），如果在后面才给他开始温度转换的话，那么很有可能跳85，导致测量结果错误，这里的延时函数也是用isp直接生成的，注意系统时间别选错了就行</p>
<p><img src="https://s2.loli.net/2024/06/07/S2nUrMHoN7eavQ1.png" alt="image-20240604205532498"></p>
<p>我们写完初始化之后就需要写一下循环了，51单片机里面必须将循环写死，所以我们用了while(1)，这里的顺序倒没什么特殊的要求，但是尽量按照我这个顺序就行，不会出问题的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    System_Init();</span><br><span class="line">    Timer0_Init();</span><br><span class="line">    Timer1_Init();</span><br><span class="line">    Set_Rtc(ucRtc);</span><br><span class="line">    rd_temperature();</span><br><span class="line">    Delay750ms();</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        Data_Proc();</span><br><span class="line">        Key_Proc();</span><br><span class="line">        Seg_Proc();</span><br><span class="line">        Uart_Proc();</span><br><span class="line">        Led_Proc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完整的main-c"><a href="#完整的main-c" class="headerlink" title="完整的main.c"></a>完整的main.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main.h&quot;</span></span></span><br><span class="line"><span class="comment">/* LED与数码管 */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> ucLed[<span class="number">8</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Seg_Pos;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Seg_Buf[<span class="number">8</span>] = &#123;<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Seg_Point[<span class="number">8</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 串口数据*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Uart_Buf[<span class="number">10</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Uart_Rx_Index;</span><br><span class="line">bit Uart_flag;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Sys_Tick;</span><br><span class="line"><span class="comment">/* 时间*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> ucRtc[<span class="number">3</span>] = &#123;<span class="number">11</span>, <span class="number">11</span>, <span class="number">11</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> time_all_1s;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 数据 */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> Freq;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Data_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">50</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 时间读取</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// AD读取</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">500</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 温度读取</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 键盘处理*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Key_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> Key_Val, Key_Down, Key_Up, Key_Old;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">10</span>) <span class="keyword">return</span>;</span><br><span class="line">  Key_Val = Key_Read();</span><br><span class="line">  Key_Down = Key_Val &amp; (Key_Old ^ Key_Val);</span><br><span class="line">  Key_Up = ~Key_Val &amp; (Key_Old ^ Key_Val);</span><br><span class="line">  Key_Old = Key_Val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 数码管处理*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Seg_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (time_all_1s % <span class="number">20</span>) <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Led_Proc</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Uart_Proc</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (Uart_Rx_Index == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (Sys_Tick &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">    Sys_Tick = Uart_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(Uart_Buf, <span class="number">0</span>, Uart_Rx_Index);</span><br><span class="line">    Uart_Rx_Index = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Timer0_Init</span><span class="params">(<span class="type">void</span>)</span>  <span class="comment">// 1毫秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  AUXR &amp;= <span class="number">0x7F</span>;  <span class="comment">// 定时器时钟12T模式</span></span><br><span class="line">  TMOD &amp;= <span class="number">0xF0</span>;  <span class="comment">// 设置定时器模式</span></span><br><span class="line">  TMOD |= <span class="number">0x05</span>;</span><br><span class="line">  TL0 = <span class="number">0</span>;  <span class="comment">// 设置定时初始值</span></span><br><span class="line">  TH0 = <span class="number">0</span>;  <span class="comment">// 设置定时初始值</span></span><br><span class="line">  TF0 = <span class="number">0</span>;  <span class="comment">// 清除TF0标志</span></span><br><span class="line">  TR0 = <span class="number">1</span>;  <span class="comment">// 定时器0开始计时</span></span><br><span class="line">  EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Timer1_Init</span><span class="params">(<span class="type">void</span>)</span>  <span class="comment">// 1毫秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  AUXR &amp;= <span class="number">0xBF</span>;  <span class="comment">// 定时器时钟12T模式</span></span><br><span class="line">  TMOD &amp;= <span class="number">0x0F</span>;  <span class="comment">// 设置定时器模式</span></span><br><span class="line">  TL1 = <span class="number">0x18</span>;    <span class="comment">// 设置定时初始值</span></span><br><span class="line">  TH1 = <span class="number">0xFC</span>;    <span class="comment">// 设置定时初始值</span></span><br><span class="line">  TF1 = <span class="number">0</span>;       <span class="comment">// 清除TF1标志</span></span><br><span class="line">  TR1 = <span class="number">1</span>;       <span class="comment">// 定时器1开始计时</span></span><br><span class="line">  ET1 = <span class="number">1</span>;       <span class="comment">// 使能定时器1中断</span></span><br><span class="line">  EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Timer1_Isr</span><span class="params">(<span class="type">void</span>)</span> interrupt 3 &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">if</span> (++time_all_1s == <span class="number">1000</span>) &#123;</span><br><span class="line">    time_all_1s = <span class="number">0</span>;</span><br><span class="line">    Freq = TH0 &lt;&lt; <span class="number">8</span> | TL0;</span><br><span class="line">    TH0 = TL0 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Uart_flag) Sys_Tick++;</span><br><span class="line">  Seg_Pos = (++Seg_Pos) % <span class="number">8</span>;</span><br><span class="line">  Seg_Disp(Seg_Pos, Seg_Buf[Seg_Pos], Seg_Point[Seg_Pos]);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) Led_Disp(i, ucLed[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Uart1_Isr</span><span class="params">(<span class="type">void</span>)</span> interrupt 4 &#123;</span><br><span class="line">  <span class="keyword">if</span> (RI) &#123;</span><br><span class="line">    Uart_flag = <span class="number">1</span>;</span><br><span class="line">    Sys_Tick = <span class="number">0</span>;</span><br><span class="line">    Uart_Buf[Uart_Rx_Index] = SBUF;</span><br><span class="line">    Uart_Rx_Index++;</span><br><span class="line">    RI = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Uart_Rx_Index &gt; <span class="number">10</span>) Uart_Rx_Index = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay750ms</span><span class="params">(<span class="type">void</span>)</span>  <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> data i, j, k;</span><br><span class="line"></span><br><span class="line">  _nop_();</span><br><span class="line">  _nop_();</span><br><span class="line">  i = <span class="number">35</span>;</span><br><span class="line">  j = <span class="number">51</span>;</span><br><span class="line">  k = <span class="number">182</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (--k);</span><br><span class="line">    &#125; <span class="keyword">while</span> (--j);</span><br><span class="line">  &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  System_Init();</span><br><span class="line">  Timer0_Init();</span><br><span class="line">  Timer1_Init();</span><br><span class="line">  Set_Rtc(ucRtc);</span><br><span class="line">  rd_temperature();</span><br><span class="line">  Delay750ms();</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    Data_Proc();</span><br><span class="line">    Key_Proc();</span><br><span class="line">    Seg_Proc();</span><br><span class="line">    Uart_Proc();</span><br><span class="line">    Led_Proc();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="main-h"><a href="#main-h" class="headerlink" title="main.h"></a>main.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K60S2.H&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds1302.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;init.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;led.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;onewire.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;seg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;uart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ul.h&quot;</span></span></span><br></pre></td></tr></table></figure>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 左岚の秘密基地
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;左岚
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    
<script
    src="https://giscus.app/client.js"
    data-repo="zuoliangyu/zuolan_blog_discussed"
    data-repo-id="R_kgDOMuHi2A"
    data-category="Announcements"
    data-category-id="DIC_kwDOMuHi2M4CiRh2"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin
    async
></script>





    
</body>
</html>
